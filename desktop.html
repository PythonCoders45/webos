<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebOS</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            cursor: default;
            user-select: none;
            overflow: hidden; /* Prevent scrolling */
        }
        .desktop {
            background-image: url('https://placehold.co/1920x1080/0d6efd/ffffff?text=WebOS+Desktop');
            background-size: cover;
            background-position: center;
            height: 100vh;
            width: 100vw;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            padding: 1rem;
            box-sizing: border-box;
        }
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            z-index: 1000;
            /* Hide the taskbar by default */
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        /* Class to make the taskbar visible */
        .taskbar.visible {
            transform: translateY(0);
        }
        .taskbar-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .taskbar-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .taskbar-button.active {
            background-color: rgba(255, 255, 255, 0.3);
            border-bottom: 2px solid #fff;
        }
        .taskbar-app-icon {
            width: 24px;
            height: 24px;
        }
        .window {
            position: absolute;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 250px;
            min-height: 200px;
            overflow: hidden;
            resize: both;
            z-index: 999;
            display: none; /* Initially hidden */
            transition: width 0.3s, height 0.3s, top 0.3s, left 0.3s, border-radius 0.3s;
        }
        .window-title-bar {
            height: 36px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab;
        }
        .window-title-bar:active {
            cursor: grabbing;
        }
        .window-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1f2937;
        }
        .window-controls {
            display: flex;
            gap: 4px;
        }
        .window-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
        }
        .window-control-btn.close { background-color: #ef4444; }
        .window-control-btn.minimize { background-color: #f59e0b; }
        .window-control-btn.maximize { background-color: #22c55e; }
        .window-content {
            padding: 1rem;
            color: #374151;
            height: calc(100% - 36px);
            overflow: auto;
        }
        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            padding: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .desktop-icon-img {
            width: 40px;
            height: 40px;
        }
        .desktop-icon-label {
            font-size: 0.75rem;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            margin-top: 4px;
        }
        .start-menu {
            position: fixed;
            bottom: 48px;
            left: 1rem;
            width: 300px;
            height: 400px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2);
            padding: 1rem;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 999;
        }
        .setup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #2d3748;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .setup-form {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        /* Style for the terminal window */
        .terminal {
            background-color: #1f2937;
            color: #f9fafb;
            font-family: 'Courier New', monospace;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
        }
        .terminal-output {
            flex-grow: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem;
        }
        .terminal-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #4b5563;
        }
        .terminal-input {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            color: #f9fafb;
            font-size: 0.875rem;
            outline: none;
        }
    </style>
</head>
<body class="bg-gray-800">

    <div id="setupScreen" class="setup-screen" style="display: none;">
        <div class="setup-form">
            <h2 class="text-2xl font-bold text-gray-800">Welcome to WebOS</h2>
            <p class="text-sm text-gray-600">Please enter your details to get started.</p>
            <div id="messageBox" class="p-3 bg-red-100 text-red-700 rounded-lg text-sm hidden"></div>
            <label class="block">
                <span class="text-gray-700">Name <span class="text-red-500">*</span></span>
                <input type="text" id="setupName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="John Doe">
            </label>
            <label class="block">
                <span class="text-gray-700">Email (Optional)</span>
                <input type="email" id="setupEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="john.doe@example.com">
            </label>
            <label class="block">
                <span class="text-gray-700">Phone (Optional)</span>
                <input type="tel" id="setupPhone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </label>
            <label class="block">
                <span class="text-gray-700">Time Zone</span>
                <select id="setupTimeZone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="GMT">Greenwich Mean Time (GMT)</option>
                    <option value="UTC">Coordinated Universal Time (UTC)</option>
                    <option value="EST">Eastern Standard Time (EST)</option>
                    <option value="CST">Central Standard Time (CST)</option>
                    <option value="MST">Mountain Standard Time (MST)</option>
                    <option value="PST">Pacific Standard Time (PST)</option>
                    <option value="CET">Central European Time (CET)</option>
                    <option value="EET">Eastern European Time (EET)</option>
                    <option value="IST">India Standard Time (IST)</option>
                    <option value="JST">Japan Standard Time (JST)</option>
                    <option value="AEST">Australian Eastern Standard Time (AEST)</option>
                    <option value="NZST">New Zealand Standard Time (NZST)</option>
                </select>
            </label>
            <label class="block">
                <span class="text-gray-700">Password <span class="text-red-500">*</span></span>
                <input type="password" id="setupPassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </label>
            <button id="saveSetupBtn" class="mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">Save</button>
        </div>
    </div>

    <div id="desktop" class="desktop" style="display: none;">
        <h1 id="welcomeMessage" class="text-3xl font-bold text-white text-shadow-md mb-4"></h1>

        <div class="desktop-icon" data-window-id="window1">
            <img src="https://placehold.co/40x40/0078d4/ffffff?text=F" class="desktop-icon-img" alt="File Explorer">
            <span class="desktop-icon-label">File Explorer</span>
        </div>
        <div class="desktop-icon" data-window-id="window3">
            <img src="https://placehold.co/40x40/10b981/ffffff?text=N" class="desktop-icon-img" alt="Notepad">
            <span class="desktop-icon-label">Notepad</span>
        </div>
        <div class="desktop-icon" data-window-id="window4">
            <img src="https://placehold.co/40x40/f97316/ffffff?text=B" class="desktop-icon-img" alt="Browser">
            <span class="desktop-icon-label">Browser</span>
        </div>
        <div class="desktop-icon" data-window-id="window5">
            <img src="https://placehold.co/40x40/6366f1/ffffff?text=C" class="desktop-icon-img" alt="Calculator">
            <span class="desktop-icon-label">Calculator</span>
        </div>
        <div class="desktop-icon" data-window-id="window7">
            <img src="https://placehold.co/40x40/555/ffffff?text=T" class="desktop-icon-img" alt="Terminal">
            <span class="desktop-icon-label">Terminal</span>
        </div>
        <div class="desktop-icon" data-window-id="wifi-app">
            <img src="https://placehold.co/40x40/0088cc/ffffff?text=W" class="desktop-icon-img" alt="Wi-Fi">
            <span class="desktop-icon-label">Wi-Fi</span>
        </div>
    </div>

    <div class="taskbar" style="display: none;">
        <div id="startButton" class="taskbar-button">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm0 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z"></path>
            </svg>
        </div>
        <div class="flex items-center gap-2" id="taskbar-app-icons">
            </div>
        <div class="text-white text-sm">
            <span id="time"></span>
        </div>
    </div>

    <div id="startMenu" class="start-menu">
        <h3 class="font-semibold text-gray-800 mb-2">Apps</h3>
        <button class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-1 text-left text-sm" data-window-id="window1">File Explorer</button>
        <button class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-1 text-left text-sm" data-window-id="window3">Notepad</button>
        <button class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-1 text-left text-sm" data-window-id="window4">Browser</button>
        <button class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-1 text-left text-sm" data-window-id="window5">Calculator</button>
        <button class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-1 text-left text-sm" data-window-id="window6">Game</button>
        <button class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-1 text-left text-sm" data-window-id="window7">Terminal</button>
        <button class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-1 text-left text-sm" data-window-id="wifi-app">Wi-Fi</button>
    </div>

    <div id="windowTemplate" class="window" style="display: none;">
        <div class="window-title-bar" data-drag-handle>
            <div class="window-title">New Window</div>
            <div class="window-controls">
                <div class="window-control-btn minimize"></div>
                <div class="window-control-btn maximize"></div>
                <div class="window-control-btn close"></div>
            </div>
        </div>
        <div class="window-content">
            <p>Window content goes here.</p>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Core OS elements ---
        const desktop = document.getElementById('desktop');
        const taskbar = document.querySelector('.taskbar');
        const startButton = document.getElementById('startButton');
        const startMenu = document.getElementById('startMenu');
        const timeDisplay = document.getElementById('time');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const setupScreen = document.getElementById('setupScreen');
        const saveSetupBtn = document.getElementById('saveSetupBtn');
        const messageBox = document.getElementById('messageBox');
        const taskbarAppIcons = document.getElementById('taskbar-app-icons');
        const windows = {}; // To store references to all windows

        // --- Setup Logic ---
        const checkSetupStatus = () => {
            const setupComplete = localStorage.getItem('setupComplete');
            if (setupComplete) {
                const userData = JSON.parse(localStorage.getItem('userData'));
                welcomeMessage.textContent = `Welcome, ${userData.name}!`;
                setupScreen.style.display = 'none';
                desktop.style.display = 'flex';
                taskbar.style.display = 'flex';
            } else {
                setupScreen.style.display = 'flex';
                desktop.style.display = 'none';
                taskbar.style.display = 'none';
            }
        };

        const showMessage = (message, isError = true) => {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.classList.remove('bg-green-100', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.remove('bg-red-100', 'text-red-700');
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
        };

        saveSetupBtn.addEventListener('click', () => {
            const name = document.getElementById('setupName').value.trim();
            const email = document.getElementById('setupEmail').value.trim();
            const phone = document.getElementById('setupPhone').value.trim();
            const timeZone = document.getElementById('setupTimeZone').value;
            const password = document.getElementById('setupPassword').value;

            if (!name || !password) {
                showMessage('Name and Password are required fields.');
                return;
            }

            const userData = {
                name,
                email,
                phone,
                timeZone,
                password
            };

            localStorage.setItem('userData', JSON.stringify(userData));
            localStorage.setItem('setupComplete', 'true');
            checkSetupStatus();
        });

        // --- Clock functionality ---
        const updateClock = () => {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            timeDisplay.textContent = timeString;
        };
        setInterval(updateClock, 1000);
        updateClock();

        // --- Start Menu functionality ---
        startButton.addEventListener('click', () => {
            startMenu.style.display = startMenu.style.display === 'flex' ? 'none' : 'flex';
        });

        // Close start menu when clicking outside
        document.addEventListener('click', (event) => {
            if (!startMenu.contains(event.target) && !startButton.contains(event.target)) {
                startMenu.style.display = 'none';
            }
        });

        // --- Window Management ---
        let zIndexCounter = 1000;

        /**
         * Initializes the calculator logic for a given window element.
         * @param {HTMLElement} windowElement The calculator window element.
         */
        const initializeCalculator = (windowElement) => {
            let displayValue = '0';
            let firstOperand = null;
            let operator = null;
            let waitingForSecondOperand = false;

            const display = windowElement.querySelector('#calc-display');
            const buttons = windowElement.querySelectorAll('button');

            const updateDisplay = () => {
                display.value = displayValue;
            };

            const handleInput = (inputValue) => {
                // If input is a number or a decimal point
                if (!isNaN(inputValue) || inputValue === '.') {
                    if (waitingForSecondOperand) {
                        displayValue = inputValue;
                        waitingForSecondOperand = false;
                    } else {
                        displayValue = displayValue === '0' ? inputValue : displayValue + inputValue;
                    }
                } 
                // If input is an operator
                else if (['+', '-', '*', '/'].includes(inputValue)) {
                    const floatValue = parseFloat(displayValue);
                    if (firstOperand === null) {
                        firstOperand = floatValue;
                    } else if (operator) {
                        const result = performCalculation();
                        displayValue = String(result);
                        firstOperand = result;
                    }
                    waitingForSecondOperand = true;
                    operator = inputValue;
                } 
                // If input is '='
                else if (inputValue === '=') {
                    if (operator && firstOperand !== null) {
                        const result = performCalculation();
                        displayValue = String(result);
                        firstOperand = null;
                        operator = null;
                        waitingForSecondOperand = false;
                    }
                } 
                // If input is 'C' (clear)
                else if (inputValue === 'C') {
                    displayValue = '0';
                    firstOperand = null;
                    operator = null;
                    waitingForSecondOperand = false;
                }
                updateDisplay();
            };

            const performCalculation = () => {
                const secondOperand = parseFloat(displayValue);
                switch (operator) {
                    case '+': return firstOperand + secondOperand;
                    case '-': return firstOperand - secondOperand;
                    case '*': return firstOperand * secondOperand;
                    case '/': return firstOperand / secondOperand;
                }
                return secondOperand;
            };

            buttons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const value = e.target.dataset.value;
                    if (value) {
                        handleInput(value);
                    }
                });
            });
        };

        /**
         * Initializes the browser logic for a given window element.
         * @param {HTMLElement} windowElement The browser window element.
         */
        const initializeBrowser = (windowElement) => {
            const urlInput = windowElement.querySelector('#urlInput');
            const goButton = windowElement.querySelector('#goButton');
            const browserIframe = windowElement.querySelector('#browserIframe');
            
            goButton.addEventListener('click', () => {
                let url = urlInput.value;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                browserIframe.src = url;
            });

            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    goButton.click();
                }
            });
        };
        
        /**
         * Initializes the game logic for a given window element.
         * @param {HTMLElement} windowElement The game window element.
         */
         const initializeGame = (windowElement) => {
            let score = 0;
            const gameButton = windowElement.querySelector('#gameButton');
            const gameScore = windowElement.querySelector('#gameScore');
            if (gameButton && gameScore) {
                gameButton.addEventListener('click', () => {
                    score++;
                    gameScore.textContent = score;
                });
            }
        };
        
        // Simulated file system data
        const fileSystem = {
            'C:': {
                'Users': {
                    'documents': {
                        'intro.txt': 'Welcome to your simulated WebOS file system. This is an example text file.',
                        'notes.txt': 'Remember to practice your coding skills every day! üöÄ'
                    },
                    'pictures': {
                        'wallpaper.jpg': '[Image data for wallpaper.jpg]'
                    },
                    'music': {
                        'song.mp3': '[Audio data for song.mp3]'
                    },
                },
                'Program Files': {
                    'WebOS': {
                        'terminal.exe': '[Executable for terminal.exe]'
                    }
                },
            }
        };

        const getDirFromPath = (path) => {
            let currentDir = fileSystem;
            const pathParts = path.split('/').filter(p => p !== '');

            for (const part of pathParts) {
                if (currentDir[part] && typeof currentDir[part] === 'object') {
                    currentDir = currentDir[part];
                } else {
                    return null; // Path does not exist or is a file
                }
            }
            return currentDir;
        };

        const resolvePath = (basePath, targetPath) => {
            const pathParts = basePath.split('/').filter(p => p !== '');
            const targetParts = targetPath.split('/').filter(p => p !== '');

            for (const part of targetParts) {
                if (part === '..') {
                    pathParts.pop();
                } else if (part !== '.') {
                    pathParts.push(part);
                }
            }
            return 'C:/' + pathParts.join('/') + (pathParts.length > 0 ? '/' : '');
        };

        /**
         * Initializes the terminal logic for a given window element.
         * @param {HTMLElement} windowElement The terminal window element.
         */
        const initializeTerminal = (windowElement) => {
            const terminalOutput = windowElement.querySelector('#terminalOutput');
            const terminalInput = windowElement.querySelector('#terminalInput');
            const terminalPromptSpan = windowElement.querySelector('#terminalPrompt');
            const userData = JSON.parse(localStorage.getItem('userData'));
            let currentPath = 'C:/';
            let isNanoMode = false;
            let nanoContent = '';
            let nanoFileName = '';
            let isPythonMode = false;

            const updatePrompt = () => {
                terminalPromptSpan.textContent = `${userData.name}@webos:${currentPath}> `;
            };

            const runCommand = (command) => {
                const fullCommand = `${userData.name}@webos:${currentPath}> ${command}`;
                terminalOutput.textContent += fullCommand + '\n';
                const [cmd, ...args] = command.trim().split(/\s+/);

                const currentDir = getDirFromPath(currentPath);

                if (!currentDir) {
                    terminalOutput.textContent += 'Error: Current directory not found.\n';
                    return;
                }

                switch (cmd) {
                    case 'echo':
                        terminalOutput.textContent += args.join(' ') + '\n';
                        break;
                    case 'ls':
                        for (const item in currentDir) {
                            const isDir = typeof currentDir[item] === 'object';
                            terminalOutput.textContent += (isDir ? 'd ' : '- ') + item + '\n';
                        }
                        break;
                    case 'cd':
                        const targetPath = args[0] || '';
                        if (targetPath === '') {
                            // Go back to home directory
                            currentPath = 'C:/Users/documents/';
                        } else {
                            const newPath = resolvePath(currentPath, targetPath);
                            if (getDirFromPath(newPath)) {
                                currentPath = newPath;
                            } else {
                                terminalOutput.textContent += `cd: no such file or directory: ${targetPath}\n`;
                            }
                        }
                        break;
                    case 'mkdir':
                        const dirName = args[0];
                        if (dirName) {
                            if (!currentDir[dirName]) {
                                currentDir[dirName] = {};
                            } else {
                                terminalOutput.textContent += `mkdir: cannot create directory '${dirName}': File exists\n`;
                            }
                        } else {
                            terminalOutput.textContent += `mkdir: missing operand\n`;
                        }
                        break;
                    case 'touch':
                        const fileName = args[0];
                        if (fileName) {
                            if (!currentDir[fileName]) {
                                currentDir[fileName] = '';
                            } else {
                                terminalOutput.textContent += `touch: '${fileName}': File exists\n`;
                            }
                        } else {
                            terminalOutput.textContent += `touch: missing file operand\n`;
                        }
                        break;
                    case 'cat':
                        const catFile = args[0];
                        if (catFile) {
                            if (currentDir[catFile] && typeof currentDir[catFile] === 'string') {
                                terminalOutput.textContent += currentDir[catFile] + '\n';
                            } else if (currentDir[catFile]) {
                                terminalOutput.textContent += `cat: ${catFile}: Is a directory\n`;
                            } else {
                                terminalOutput.textContent += `cat: ${catFile}: No such file or directory\n`;
                            }
                        } else {
                            terminalOutput.textContent += `cat: missing file operand\n`;
                        }
                        break;
                    case 'rm':
                        const rmName = args[0];
                        if (rmName) {
                            if (currentDir[rmName]) {
                                if (typeof currentDir[rmName] === 'object' && Object.keys(currentDir[rmName]).length > 0) {
                                    terminalOutput.textContent += `rm: cannot remove '${rmName}': Directory not empty\n`;
                                } else {
                                    delete currentDir[rmName];
                                }
                            } else {
                                terminalOutput.textContent += `rm: cannot remove '${rmName}': No such file or directory\n`;
                            }
                        } else {
                            terminalOutput.textContent += `rm: missing operand\n`;
                        }
                        break;
                    case 'pip':
                        if (args[0] === 'install') {
                            const packageName = args[1];
                            if (packageName) {
                                terminalOutput.textContent += `\nCollecting ${packageName}\n  Downloading ${packageName}-1.0.tar.gz (5.4 MB)\n     |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5.4 MB 1.2 MB/s\n  Installing collected packages: ${packageName}\nSuccessfully installed ${packageName}-1.0\n\n`;
                            } else {
                                terminalOutput.textContent += `pip install: missing package name\n`;
                            }
                        } else {
                            terminalOutput.textContent += `pip: unknown command '${args[0]}'\n`;
                        }
                        break;
                    case 'nano':
                        const fileToEdit = args[0];
                        if (!fileToEdit) {
                            terminalOutput.textContent += `nano: missing file name\n`;
                            break;
                        }
                        // Check if file exists, if not, create it
                        const filePath = resolvePath(currentPath, fileToEdit);
                        const fileParentDir = getDirFromPath(filePath.substring(0, filePath.lastIndexOf('/')));
                        const fileNameOnly = filePath.substring(filePath.lastIndexOf('/') + 1);

                        if (!fileParentDir) {
                            terminalOutput.textContent += `nano: cannot create file '${fileToEdit}': No such directory\n`;
                            break;
                        }

                        if (!fileParentDir[fileNameOnly]) {
                            fileParentDir[fileNameOnly] = '';
                        }
                        
                        // Enter nano mode
                        isNanoMode = true;
                        nanoFileName = fileNameOnly;
                        nanoContent = fileParentDir[fileNameOnly];
                        terminalOutput.textContent = `\nGNU nano 2.9.8                       ${fileToEdit}\n\n`;
                        terminalOutput.textContent += nanoContent;
                        terminalOutput.textContent += `\n\n\n\n\n\n\n\n\n\n^X Exit`;
                        terminalInput.value = '';
                        break;
                    case 'python':
                    case 'python3':
                        isPythonMode = true;
                        terminalOutput.textContent += `Python 3.8.10 (default, Sep 28 2021, 13:41:40)\n[GCC 9.3.0] on linux\nType "help", "copyright", "credits" or "license" for more information.\n`;
                        terminalPromptSpan.textContent = '>>> ';
                        break;
                    case 'clear':
                        terminalOutput.textContent = '';
                        break;
                    case 'whoami':
                        terminalOutput.textContent += userData.name + '\n';
                        break;
                    default:
                        terminalOutput.textContent += `Command not found: ${cmd}\n`;
                }

                if (!isNanoMode && !isPythonMode) {
                    terminalInput.value = '';
                    updatePrompt();
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                }
            };

            const handlePythonInput = (input) => {
                if (input.trim() === 'exit()') {
                    isPythonMode = false;
                    terminalOutput.textContent += '\n';
                    updatePrompt();
                    terminalInput.value = '';
                    return;
                }

                // Simple Python simulation
                try {
                    // This is a very basic evaluation and can be expanded
                    // NOTE: This uses eval() which can be a security risk in a real application.
                    // For this simple, sandboxed simulation, it's acceptable.
                    if (input.includes('print(')) {
                        const content = input.substring(input.indexOf('(') + 1, input.lastIndexOf(')'));
                        terminalOutput.textContent += eval(content.trim()) + '\n';
                    } else if (input.trim() !== '') {
                        terminalOutput.textContent += eval(input) + '\n';
                    }
                } catch (e) {
                    terminalOutput.textContent += `SyntaxError: invalid syntax\n`;
                }
            };
            
            terminalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (isNanoMode) {
                        const newContent = terminalInput.value;
                        const currentDir = getDirFromPath(currentPath);
                        currentDir[nanoFileName] = newContent;
                        terminalOutput.textContent = `${newContent}\n^X Exit\nSaved to ${nanoFileName}\n\n`;
                        isNanoMode = false;
                        terminalInput.value = '';
                        updatePrompt();
                    } else if (isPythonMode) {
                        const currentInput = terminalInput.value;
                        terminalOutput.textContent += `>>> ${currentInput}\n`;
                        handlePythonInput(currentInput);
                        terminalInput.value = '';
                        terminalOutput.scrollTop = terminalOutput.scrollHeight;
                    } else {
                        runCommand(terminalInput.value);
                    }
                }
            });

            // Initial prompt setup
            updatePrompt();
        };


        // Function to render the file system content
        const renderFileSystem = (windowElement, path) => {
            const fileList = windowElement.querySelector('#fileList');
            fileList.innerHTML = '';
            let currentDir = getDirFromPath(path);

            if (!currentDir) {
                fileList.innerHTML = 'Error: Path not found.';
                return;
            }

            // Display current path
            windowElement.querySelector('#currentPath').textContent = path;

            // Back button
            if (path !== 'C:/') {
                const backElement = document.createElement('div');
                backElement.classList.add('flex', 'items-center', 'gap-2', 'p-2', 'hover:bg-gray-200', 'cursor-pointer', 'rounded');
                backElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414L6 10.586 7.293 11.88a1 1 0 001.414-1.414L7.414 10l2.293-2.293z" clip-rule="evenodd" />
                    </svg>
                    <span>...</span>
                `;
                backElement.addEventListener('dblclick', () => {
                    const newPath = path.substring(0, path.lastIndexOf('/', path.length - 2) + 1);
                    renderFileSystem(windowElement, newPath);
                });
                fileList.appendChild(backElement);
            }

            // Render folders and files
            for (const item in currentDir) {
                const isDir = typeof currentDir[item] === 'object';
                const itemElement = document.createElement('div');
                itemElement.classList.add('flex', 'items-center', 'gap-2', 'p-2', 'hover:bg-gray-200', 'cursor-pointer', 'rounded');
                itemElement.dataset.name = item;
                itemElement.dataset.type = isDir ? 'dir' : 'file';

                const icon = isDir
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                           <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                       </svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm6 0a1 1 0 011 1v1a1 1 0 11-2 0V5a1 1 0 011-1z" clip-rule="evenodd" />
                       </svg>`;

                itemElement.innerHTML = `${icon}<span>${item}</span>`;

                itemElement.addEventListener('dblclick', () => {
                    if (isDir) {
                        renderFileSystem(windowElement, `${path}${item}/`);
                    } else {
                        // Open file in Notepad
                        const noteTitle = `Notepad - ${item}`;
                        const noteContent = `<textarea class="w-full h-full bg-gray-100 p-2 rounded text-sm resize-none focus:outline-none" placeholder="Start typing...">${currentDir[item]}</textarea>`;
                        createWindow(`notepad-${Date.now()}`, noteTitle, noteContent);
                    }
                });

                fileList.appendChild(itemElement);
            }
        };

        // --- Files App Logic ---
        const initializeFilesApp = (windowElement) => {
            // Helpers
            function el(q){ return windowElement.querySelector(q); }
            function fmtBytes(n){
                if(n===null || n===undefined) return '';
                if(n<1024) return n+' B';
                if(n<1024*1024) return (n/1024).toFixed(1)+' KB';
                if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' MB';
                return (n/1024/1024/1024).toFixed(2)+' GB';
            }
            
            // Render devices returned by /api/storage
            async function fetchDevices(){
                const listDiv = el('#devices-list');
                listDiv.innerHTML = 'Scanning...';
                try{
                    const res = await fetch('/api/storage');
                    if(!res.ok) throw new Error('HTTP '+res.status);
                    const data = await res.json();
                    if(!data.devices || data.devices.length===0){
                        listDiv.innerHTML = '<i>No removable devices found</i>';
                        return;
                    }
                    listDiv.innerHTML = '';
                    data.devices.forEach(dev=>{
                        const d = document.createElement('div');
                        d.style.padding='6px';
                        d.style.borderBottom='1px solid #222';
                        d.innerHTML = `<b>${dev.label || dev.mount || dev.name}</b><br>
                                        <small>${dev.mount}</small><br>
                                        <small>${fmtBytes(dev.free)} free of ${fmtBytes(dev.total)}</small>`;
                        d.onclick = ()=>selectDevice(dev);
                        listDiv.appendChild(d);
                    });
                }catch(err){
                    listDiv.innerHTML = '<span style="color:#f66">Error scanning devices</span>';
                    console.error('fetchDevices', err);
                }
            }
            
            async function selectDevice(dev){
                // show root path listing for device.mount
                await listPath(dev.mount);
                el('#path-breadcrumb').innerText = dev.mount;
            }
            
            async function listPath(path){
                const list = el('#files-list');
                list.innerHTML = 'Loading...';
                try{
                    const res = await fetch('/api/list?path=' + encodeURIComponent(path));
                    if(!res.ok) throw new Error('HTTP '+res.status);
                    const data = await res.json();
                    list.innerHTML = '';
                    // parent link
                    const parent = document.createElement('div');
                    parent.style.opacity = 0.8;
                    parent.textContent = '.. (up)';
                    parent.onclick = async ()=>{
                        if(!data.parent) return;
                        await listPath(data.parent);
                        el('#path-breadcrumb').innerText = data.parent;
                    };
                    list.appendChild(parent);
            
                    data.entries.forEach(e=>{
                        const row = document.createElement('div');
                        row.style.display='flex';
                        row.style.justifyContent='space-between';
                        row.style.alignItems='center';
                        row.style.padding='4px 2px';
                        row.innerHTML = `<div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                            ${e.is_dir ? 'üìÅ' : 'üìÑ'} <b>${e.name}</b>
                                        </div>
                                        <div style="text-align:right;min-width:160px;">
                                            <small>${e.is_dir ? '' : fmtBytes(e.size)} ${e.mtime ? ' ‚Ä¢ '+(new Date(e.mtime*1000)).toLocaleString() : ''}</small>
                                            ${!e.is_dir ? ` <button data-path="${encodeURIComponent(e.path)}" class="download-btn">Download</button>` : ''}
                                        </div>`;
                        // click on dir to open
                        if(e.is_dir){
                            row.onclick = ()=>listPath(e.path) && (el('#path-breadcrumb').innerText = e.path);
                        }
                        list.appendChild(row);
                    });
            
                    // attach download handlers
                    windowElement.querySelectorAll('.download-btn').forEach(btn=>{
                        btn.addEventListener('click', ev=>{
                            ev.stopPropagation();
                            const p = decodeURIComponent(btn.getAttribute('data-path'));
                            window.location.href = '/api/download?path=' + encodeURIComponent(p);
                        });
                    });
                }catch(err){
                    list.innerHTML = '<span style="color:#f66">Failed to list path</span>';
                    console.error('listPath', err);
                }
            }
            
            // wire refresh
            el('#refresh-devices').addEventListener('click', fetchDevices);
            
            // init
            fetchDevices();
        };

        // NEW: Wi-Fi App Logic
        function scanWifiNetworks(){
          if(!window.webOS){
            // fallback: simulate
            updateNetworks([{ssid:'HomeNet',security:true},{ssid:'Cafe',security:false}]);
            return;
          }
          webOS.service.request("luna://com.webos.service.wifi/scan", {
            method: "scan",
            parameters: {},
            onSuccess: res => { if(res && res.results) updateNetworks(res.results); else updateNetworks([]); },
            onFailure: err => { console.error('scan failed',err); updateNetworks([]); }
          });
        }

        function connectToWifi(ssid, password){
          if(!window.webOS) { alert('Simulated connect to '+ssid); return; }
          webOS.service.request("luna://com.webos.service.wifi/connect", {
            parameters: { ssid: ssid, password: password },
            onSuccess: r => alert('Connected: '+ssid),
            onFailure: e => alert('Connect failed: '+(e.errorText||JSON.stringify(e)))
          });
        }

        const initializeWifiApp = (windowElement) => {
            const scanButton = windowElement.querySelector('#scanNetworksBtn');
            const networksList = windowElement.querySelector('#wifiNetworksList');

            scanButton.addEventListener('click', () => {
                scanWifiNetworks();
            });

            window.updateNetworks = (networks) => {
                networksList.innerHTML = '';
                if (networks.length === 0) {
                    networksList.innerHTML = '<p class="text-gray-500">No networks found.</p>';
                    return;
                }

                networks.forEach(network => {
                    const networkItem = document.createElement('div');
                    networkItem.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'border-b', 'border-gray-300', 'cursor-pointer', 'hover:bg-gray-200');
                    networkItem.innerHTML = `
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10.293 2.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 10H6a1 1 0 110-2h6.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            <span>${network.ssid}</span>
                        </div>
                        <div class="flex items-center gap-1 text-xs text-gray-500">
                            ${network.security ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2h2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2h2zm8 0H7V7a3 3 0 116 0v2z" clip-rule="evenodd" /></svg> Secured' : 'Open'}
                        </div>
                    `;
                    networkItem.addEventListener('click', () => {
                        const password = network.security ? prompt('Enter password for ' + network.ssid) : null;
                        connectToWifi(network.ssid, password);
                    });
                    networksList.appendChild(networkItem);
                });
            };
        };

        // Function to create and open a new window
        const createWindow = (id, title, content) => {
            if (windows[id]) {
                // If window already exists, restore and focus it
                if (windows[id].windowElement.style.display === 'none') {
                    windows[id].windowElement.style.display = 'block';
                }
                bringToFront(windows[id].windowElement);
                return;
            }

            // Clone the template and set up window properties
            const windowElement = document.getElementById('windowTemplate').cloneNode(true);
            windowElement.id = `window-${id}`;
            windowElement.style.display = 'block';
            windowElement.querySelector('.window-title').textContent = title;
            windowElement.querySelector('.window-content').innerHTML = content;
            windowElement.style.top = `${Math.random() * (window.innerHeight - 450) + 50}px`;
            windowElement.style.left = `${Math.random() * (window.innerWidth - 650) + 50}px`;
            windowElement.style.width = '600px';
            windowElement.style.height = '400px';
            bringToFront(windowElement);

            // Add the window to the desktop
            desktop.appendChild(windowElement);

            // Add window reference to the global object, including a new state for maximization
            windows[id] = { 
                windowElement: windowElement, 
                isMaximized: false,
                initialX: windowElement.offsetLeft,
                initialY: windowElement.offsetTop,
                initialWidth: windowElement.offsetWidth,
                initialHeight: windowElement.offsetHeight,
                currentX: 0,
                currentY: 0
            };

            // Add a taskbar button for the new window
            const taskbarButton = document.createElement('div');
            taskbarButton.classList.add('taskbar-button', 'taskbar-app-button');
            taskbarButton.innerHTML = `<img src="https://placehold.co/24x24/ffffff/0d6efd?text=${title.charAt(0)}" class="taskbar-app-icon" alt="${title} icon">`;
            taskbarAppIcons.appendChild(taskbarButton);

            taskbarButton.addEventListener('click', () => {
                if (windowElement.style.display === 'none') {
                    windowElement.style.display = 'block';
                    bringToFront(windowElement);
                } else {
                    windowElement.style.display = 'none';
                }
            });

            // --- Window controls ---
            const closeBtn = windowElement.querySelector('.window-control-btn.close');
            const minimizeBtn = windowElement.querySelector('.window-control-btn.minimize');
            const maximizeBtn = windowElement.querySelector('.window-control-btn.maximize');

            closeBtn.addEventListener('click', () => {
                windowElement.remove();
                taskbarButton.remove();
                delete windows[id];
            });

            minimizeBtn.addEventListener('click', () => {
                windowElement.style.display = 'none';
            });
            
            // New logic for maximizing to fill the screen
            maximizeBtn.addEventListener('click', () => {
                const windowData = windows[id];
                if (!windowData.isMaximized) {
                    // Save old position and size
                    windowData.initialX = windowElement.offsetLeft;
                    windowData.initialY = windowElement.offsetTop;
                    windowData.initialWidth = windowElement.offsetWidth;
                    windowData.initialHeight = windowElement.offsetHeight;

                    // Maximize the window
                    windowElement.style.top = '0';
                    windowElement.style.left = '0';
                    windowElement.style.width = '100vw';
                    windowElement.style.height = '100vh';
                    windowElement.style.borderRadius = '0';
                    windowElement.style.transform = 'none'; // Clear any drag transform
                    windowElement.style.resize = 'none'; // Disable resizing
                    windowData.isMaximized = true;

                } else {
                    // Restore to previous position and size
                    windowElement.style.top = `${windowData.initialY}px`;
                    windowElement.style.left = `${windowData.initialX}px`;
                    windowElement.style.width = `${windowData.initialWidth}px`;
                    windowElement.style.height = `${windowData.initialHeight}px`;
                    windowElement.style.borderRadius = '12px';
                    windowElement.style.resize = 'both'; // Enable resizing
                    windowData.isMaximized = false;
                }
            });


            // --- Drag functionality ---
            const titleBar = windowElement.querySelector('.window-title-bar');
            let isDragging = false;
            const windowData = windows[id];

            titleBar.addEventListener('mousedown', (e) => {
                if (windowData.isMaximized) return; // Prevent dragging when maximized
                bringToFront(windowElement);
                isDragging = true;
                windowData.currentX = windowElement.offsetLeft;
                windowData.currentY = windowElement.offsetTop;
                windowData.initialX = e.clientX;
                windowData.initialY = e.clientY;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging || windowData.isMaximized) return;
                e.preventDefault();
                const dx = e.clientX - windowData.initialX;
                const dy = e.clientY - windowData.initialY;
                windowElement.style.left = `${windowData.currentX + dx}px`;
                windowElement.style.top = `${windowData.currentY + dy}px`;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // Call specific initialization functions
            if (id === 'window1') {
                renderFileSystem(windowElement, 'C:/');
            } else if (id === 'window3') {
                const saveBtn = windowElement.querySelector('#saveNoteBtn');
                saveBtn.addEventListener('click', () => {
                    const textarea = windowElement.querySelector('textarea');
                    const content = textarea.value;
                    const timestamp = new Date().getTime();
                    const fileName = `note_${timestamp}.txt`;
                    
                    // Add the new file to the simulated file system
                    fileSystem['C:']['Users']['documents'][fileName] = content;
                    
                    // Show a confirmation message
                    const confirmation = document.createElement('p');
                    confirmation.textContent = `File saved as ${fileName} in C:/Users/documents/`;
                    confirmation.classList.add('text-green-600', 'mt-2');
                    windowElement.querySelector('.window-content').appendChild(confirmation);

                    // Re-render the file explorer to show the new file if it's open
                    if (windows['window1'] && windows['window1'].windowElement.style.display !== 'none') {
                        renderFileSystem(windows['window1'].windowElement, 'C:/Users/documents/');
                    }
                });
            } else if (id === 'window4') {
                initializeBrowser(windowElement);
            } else if (id === 'window5') {
                initializeCalculator(windowElement);
            } else if (id === 'window6') {
                initializeGame(windowElement);
            } else if (id === 'window7') {
                initializeTerminal(windowElement);
            } else if (id === 'files-app') {
                initializeFilesApp(windowElement);
            } else if (id === 'wifi-app') {
                initializeWifiApp(windowElement);
            }
        };

        // Brings a window to the front by increasing its z-index
        const bringToFront = (windowEl) => {
            zIndexCounter++;
            windowEl.style.zIndex = zIndexCounter;
        };

        // New logic for the auto-hiding taskbar
        let taskbarHideTimeout;
        document.addEventListener('mousemove', (e) => {
            if (e.clientY > window.innerHeight - 50) {
                clearTimeout(taskbarHideTimeout);
                taskbar.classList.add('visible');
            } else if (e.target.closest('.taskbar') === null) {
                taskbarHideTimeout = setTimeout(() => {
                    taskbar.classList.remove('visible');
                }, 500);
            }
        });
        
        taskbar.addEventListener('mouseenter', () => {
            clearTimeout(taskbarHideTimeout);
            taskbar.classList.add('visible');
        });

        // Event listeners for desktop icons
        document.querySelectorAll('.desktop-icon').forEach(icon => {
            icon.addEventListener('dblclick', (e) => {
                const windowId = e.currentTarget.dataset.windowId;
                let title = '';
                let content = '';

                if (windowId === 'window1') {
                    title = 'File Explorer';
                    content = `
                        <div class="flex flex-col h-full">
                            <div class="flex items-center gap-2 p-2 bg-gray-200">
                                <span id="currentPath" class="text-sm font-mono text-gray-700"></span>
                            </div>
                            <div class="p-2">
                                <button id="open-removable" class="bg-gray-300 rounded-lg p-2 text-xs font-semibold hover:bg-gray-400 transition-colors">Open Removable Devices</button>
                            </div>
                            <div id="fileList" class="flex flex-col flex-grow p-2">
                                </div>
                        </div>
                    `;
                } else if (windowId === 'window3') {
                    title = 'Notepad';
                    content = `
                        <div class="flex flex-col h-full">
                            <textarea class="flex-grow w-full bg-gray-100 p-2 rounded text-sm resize-none focus:outline-none" placeholder="Start typing..."></textarea>
                            <button id="saveNoteBtn" class="mt-2 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">Save</button>
                        </div>
                    `;
                } else if (windowId === 'window4') {
                    title = 'Browser';
                    content = `
                        <div id="browserIcon" class="desktop-icon" style="top:50px; left:50px; width:80px; text-align:center; cursor:pointer; user-select:none;">
  üåê<div>Browser</div>
</div>

                    `;
                } else if (windowId === 'window5') {
                    title = 'Calculator';
                    content = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <input id="calc-display" type="text" class="w-full p-2 text-right text-2xl mb-2 rounded bg-gray-100" value="0" readonly />
                            <div class="grid grid-cols-4 gap-2 w-full">
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="7">7</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="8">8</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="9">9</button>
                                <button class="bg-yellow-400 rounded p-4 text-xl" data-value="/">/</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="4">4</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="5">5</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="6">6</button>
                                <button class="bg-yellow-400 rounded p-4 text-xl" data-value="*">*</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="1">1</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="2">2</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="3">3</button>
                                <button class="bg-yellow-400 rounded p-4 text-xl" data-value="-">-</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="0">0</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value=".">.</button>
                                <button class="bg-red-500 rounded p-4 text-xl text-white" data-value="C">C</button>
                                <button class="bg-yellow-400 rounded p-4 text-xl" data-value="+">+</button>
                                <button class="col-span-4 bg-green-500 rounded p-4 text-xl text-white" data-value="=">=</button>
                            </div>
                        </div>
                    `;
                } else if (windowId === 'window6') {
                    title = 'Game';
                    content = `
                        <div class="flex flex-col items-center justify-center h-full gap-4">
                            <p class="text-xl">Click the button as many times as you can!</p>
                            <button id="gameButton" class="bg-blue-500 text-white rounded-full p-8 text-2xl font-bold hover:bg-blue-600 transition-colors">
                                Click Me!
                            </button>
                            <p class="text-3xl font-bold">Score: <span id="gameScore">0</span></p>
                        </div>
                    `;
                } else if (windowId === 'window7') {
                    title = 'Terminal';
                    content = `
                        <div class="terminal flex flex-col h-full">
                            <pre id="terminalOutput" class="terminal-output flex-grow p-2"></pre>
                            <div class="terminal-input-container">
                                <span id="terminalPrompt" class="text-green-500"></span>
                                <input type="text" id="terminalInput" class="terminal-input" autofocus>
                            </div>
                        </div>
                    `;
                } else if (windowId === 'wifi-app') {
                    title = 'Wi-Fi';
                    content = `
                        <div class="flex flex-col h-full p-4">
                            <div class="flex justify-between items-center pb-4 border-b border-gray-300">
                                <h3 class="text-lg font-semibold">Available Networks</h3>
                                <button id="scanNetworksBtn" class="bg-blue-500 text-white text-xs px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Scan</button>
                            </div>
                            <div id="wifiNetworksList" class="flex flex-col flex-grow pt-4 overflow-y-auto">
                                <p class="text-gray-500">Click 'Scan' to find networks.</p>
                            </div>
                        </div>
                    `;
                }

                createWindow(windowId, title, content);
                startMenu.style.display = 'none';
            });
        });

        // Event listeners for start menu buttons
        document.querySelectorAll('#startMenu button').forEach(button => {
            button.addEventListener('click', (e) => {
                const windowId = e.currentTarget.dataset.window-id;
                let title = e.currentTarget.textContent;
                let content = '';
                
                if (windowId === 'window1') {
                    title = 'File Explorer';
                    content = `
                        <div class="flex flex-col h-full">
                            <div class="flex items-center gap-2 p-2 bg-gray-200">
                                <span id="currentPath" class="text-sm font-mono text-gray-700"></span>
                            </div>
                            <div class="p-2">
                                <button id="open-removable" class="bg-gray-300 rounded-lg p-2 text-xs font-semibold hover:bg-gray-400 transition-colors">Open Removable Devices</button>
                            </div>
                            <div id="fileList" class="flex flex-col flex-grow p-2">
                                </div>
                        </div>
                    `;
                } else if (windowId === 'window3') {
                    title = 'Notepad';
                    content = `
                        <div class="flex flex-col h-full">
                            <textarea class="flex-grow w-full bg-gray-100 p-2 rounded text-sm resize-none focus:outline-none" placeholder="Start typing..."></textarea>
                            <button id="saveNoteBtn" class="mt-2 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">Save</button>
                        </div>
                    `;
                } else if (windowId === 'window4') {
                    title = 'Browser';
                    content = `
                        <div class="flex flex-col h-full">
                            <div class="flex items-center gap-2 p-2 bg-gray-200">
                                <input type="text" id="urlInput" value="https://www.google.com" class="flex-grow p-1 rounded bg-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <button id="goButton" class="bg-gray-400 text-xs px-2 py-1 rounded hover:bg-gray-500 transition-colors">Go</button>
                            </div>
                            <iframe id="browserIframe" src="https://www.google.com" class="flex-grow w-full border-0"></iframe>
                        </div>
                    `;
                } else if (windowId === 'window5') {
                    title = 'Calculator';
                    content = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <input id="calc-display" type="text" class="w-full p-2 text-right text-2xl mb-2 rounded bg-gray-100" value="0" readonly />
                            <div class="grid grid-cols-4 gap-2 w-full">
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="7">7</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="8">8</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="9">9</button>
                                <button class="bg-yellow-400 rounded p-4 text-xl" data-value="/">/</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="4">4</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="5">5</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="6">6</button>
                                <button class="bg-yellow-400 rounded p-4 text-xl" data-value="*">*</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="1">1</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="2">2</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="3">3</button>
                                <button class="bg-yellow-400 rounded p-4 text-xl" data-value="-">-</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value="0">0</button>
                                <button class="bg-gray-300 rounded p-4 text-xl" data-value=".">.</button>
                                <button class="bg-red-500 rounded p-4 text-xl text-white" data-value="C">C</button>
                                <button class="bg-yellow-400 rounded p-4 text-xl" data-value="+">+</button>
                                <button class="col-span-4 bg-green-500 rounded p-4 text-xl text-white" data-value="=">=</button>
                            </div>
                        </div>
                    `;
                } else if (windowId === 'window6') {
                    title = 'Game';
                    content = `
                        <div class="flex flex-col items-center justify-center h-full gap-4">
                            <p class="text-xl">Click the button as many times as you can!</p>
                            <button id="gameButton" class="bg-blue-500 text-white rounded-full p-8 text-2xl font-bold hover:bg-blue-600 transition-colors">
                                Click Me!
                            </button>
                            <p class="text-3xl font-bold">Score: <span id="gameScore">0</span></p>
                        </div>
                    `;
                } else if (windowId === 'window7') {
                    title = 'Terminal';
                    content = `
                        <div class="terminal flex flex-col h-full">
                            <pre id="terminalOutput" class="terminal-output flex-grow p-2"></pre>
                            <div class="terminal-input-container">
                                <span id="terminalPrompt" class="text-green-500"></span>
                                <input type="text" id="terminalInput" class="terminal-input" autofocus>
                            </div>
                        </div>
                    `;
                } else if (windowId === 'wifi-app') {
                    title = 'Wi-Fi';
                    content = `
                        <div class="flex flex-col h-full p-4">
                            <div class="flex justify-between items-center pb-4 border-b border-gray-300">
                                <h3 class="text-lg font-semibold">Available Networks</h3>
                                <button id="scanNetworksBtn" class="bg-blue-500 text-white text-xs px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Scan</button>
                            </div>
                            <div id="wifiNetworksList" class="flex flex-col flex-grow pt-4 overflow-y-auto">
                                <p class="text-gray-500">Click 'Scan' to find networks.</p>
                            </div>
                        </div>
                    `;
                }

                createWindow(windowId, title, content);
                startMenu.style.display = 'none';
            });
        });

        // Event listener to bring clicked window to the front
        desktop.addEventListener('mousedown', (e) => {
            const window = e.target.closest('.window');
            if (window) {
                bringToFront(window);
            }
        });

        // Event listener for the new "Removable Devices" button inside the old File Explorer
        document.addEventListener('click', (e) => {
            if (e.target.id === 'open-removable') {
                const title = 'Removable Devices';
                const content = `
                    <div id="files-app">
                        <div style="display:flex;gap:12px; height: 100%;">
                            <div style="width:320px; color: black; background: #eee; padding: 12px; overflow-y: auto;">
                                <h3 style="font-weight: bold; margin-bottom: 8px;">Removable devices</h3>
                                <div id="devices-list">Loading devices‚Ä¶</div>
                                <button id="refresh-devices" class="mt-4 px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 transition-colors">Refresh</button>
                            </div>
                            <div style="flex:1; color: black; background: #fefefe; padding: 12px; display: flex; flex-direction: column;">
                                <h3 style="font-weight: bold; margin-bottom: 8px;">Files</h3>
                                <div id="path-breadcrumb" style="font-family: monospace; font-size: 0.8em; color: #555; margin-bottom: 8px;"></div>
                                <div id="files-list" style="flex: 1; overflow: auto; border:1px solid #ccc; padding:6px; background:#fff; font-family: monospace;"></div>
                            </div>
                        </div>
                    </div>
                `;
                createWindow('files-app', title, content);
            }
        });

        // Initial check on page load
        checkSetupStatus();
    });
</script>
<script>
/* --- Virtual Desks --- */
const NUM_DESKS = 10; // Number of virtual desks
const desks = {};
const windows = document.querySelectorAll('.window'); // existing windows

// Initialize desks
for (let i = 1; i <= NUM_DESKS; i++) {
  desks[i] = [];
}

// Put all windows on Desk 1 initially
windows.forEach(win => desks[1].push(win));

// Show only Desk 1 windows initially
Object.keys(desks).forEach(d => {
  desks[d].forEach(w => w.style.display = d == 1 ? 'block' : 'none');
});

// Function to switch desk
function switchDesk(deskNumber) {
  Object.keys(desks).forEach(d => {
    desks[d].forEach(w => w.style.display = 'none');
  });
  desks[deskNumber].forEach(w => w.style.display = 'block');
}

/* --- Sliders for Volume, Mic, Brightness --- */
const taskbarTime = document.querySelector('#time'); // existing time element in your taskbar
if(taskbarTime) {
  const sliderPanel = document.createElement('div');
  sliderPanel.id = 'slider-panel';
  sliderPanel.style.position = 'absolute';
  sliderPanel.style.bottom = '40px';
  sliderPanel.style.right = '10px';
  sliderPanel.style.background = '#222';
  sliderPanel.style.padding = '10px';
  sliderPanel.style.borderRadius = '5px';
  sliderPanel.style.display = 'none';
  sliderPanel.style.zIndex = '9999';
  sliderPanel.style.color = '#fff';

  sliderPanel.innerHTML = `
    <label>Volume <input type="range" id="volume-slider" min="0" max="100" value="50"></label><br>
    <label>Mic <input type="range" id="mic-slider" min="0" max="100" value="50"></label><br>
    <label>Brightness <input type="range" id="brightness-slider" min="0" max="100" value="100"></label>
  `;

  document.body.appendChild(sliderPanel);

  taskbarTime.addEventListener('click', () => {
    sliderPanel.style.display = sliderPanel.style.display === 'none' ? 'block' : 'none';
  });

  // Optional: link brightness slider to desktop background brightness
  const desktop = document.getElementById('desktop');
  const brightnessSlider = document.getElementById('brightness-slider');
  brightnessSlider.addEventListener('input', () => {
    if(desktop) desktop.style.filter = `brightness(${brightnessSlider.value}%)`;
  });
}
</script>
<script>
/* --- Virtual Desks --- */
const NUM_DESKS = 10; // number of virtual desktops
const desks = {};
const windows = document.querySelectorAll('.window'); // all existing windows

// Initialize desks
for (let i = 1; i <= NUM_DESKS; i++) {
  desks[i] = [];
}

// Put all windows on Desk 1 initially
windows.forEach(win => desks[1].push(win));

// Show only Desk 1 windows initially
Object.keys(desks).forEach(d => {
  desks[d].forEach(w => w.style.display = d == 1 ? 'block' : 'none');
});

// Function to switch desk
function switchDesk(deskNumber) {
  Object.keys(desks).forEach(d => {
    desks[d].forEach(w => w.style.display = 'none');
  });
  desks[deskNumber].forEach(w => w.style.display = 'block');
}

/* --- Taskbar Integration --- */
const taskbar = document.querySelector('#taskbar'); // adjust to your taskbar ID
const timeEl = document.querySelector('#time'); // existing time element

if(taskbar){

  // Create a container for desk buttons
  const deskContainer = document.createElement('div');
  deskContainer.style.display = 'flex';
  deskContainer.style.alignItems = 'center';
  deskContainer.style.marginRight = '10px';
  taskbar.insertBefore(deskContainer, timeEl);

  // Add desk buttons
  for(let i=1; i<=NUM_DESKS; i++){
    const btn = document.createElement('div');
    btn.textContent = 'Desk ' + i;
    btn.classList.add('desk-btn');
    btn.style.cursor = 'pointer';
    btn.style.margin = '0 3px';
    btn.style.padding = '2px 5px';
    btn.style.background = i===1 ? '#00aaff' : '#555';
    btn.style.color = '#fff';
    btn.style.borderRadius = '3px';
    deskContainer.appendChild(btn);

    btn.addEventListener('click', () => {
      switchDesk(i);
      // update active desk highlight
      document.querySelectorAll('.desk-btn').forEach(b => b.style.background = '#555');
      btn.style.background = '#00aaff';
    });
  }

  // Add battery icon with percent
  const batteryContainer = document.createElement('div');
  batteryContainer.style.display = 'flex';
  batteryContainer.style.alignItems = 'center';
  batteryContainer.style.marginLeft = '10px';
  taskbar.insertBefore(batteryContainer, timeEl);

  const batteryIcon = document.createElement('span');
  batteryIcon.innerHTML = '&#128267;'; // battery icon (Unicode)
  batteryIcon.style.marginRight = '5px';
  batteryIcon.style.color = '#fff';
  batteryContainer.appendChild(batteryIcon);

  const batteryPercent = document.createElement('span');
  batteryPercent.textContent = '100%';
  batteryPercent.style.color = '#fff';
  batteryContainer.appendChild(batteryPercent);

  // Update battery percent using Battery API
  if(navigator.getBattery){
    navigator.getBattery().then(battery => {
      function updateBattery() {
        const pct = Math.round(battery.level * 100);
        batteryPercent.textContent = pct + '%';
      }
      updateBattery();
      battery.addEventListener('levelchange', updateBattery);
    });
  }
}
</script>
<script>
// --- Virtual Desks ---
const NUM_DESKS = 10;
const desks = {};
document.querySelectorAll('.window').forEach(win => desks[1] ? desks[1].push(win) : desks[1] = [win]);
for(let i=2;i<=NUM_DESKS;i++) desks[i]=[];

function switchDesk(n){
  Object.values(desks).forEach(arr=>arr.forEach(w=>w.style.display='none'));
  desks[n].forEach(w=>w.style.display='block');
}

// --- Taskbar Integration ---
let taskbar = document.querySelector('#taskbar') || document.querySelector('body > div:last-child');
if(!taskbar) console.warn('No taskbar found');
else {
  // Desk buttons container
  const deskContainer = document.createElement('div');
  deskContainer.style.display='flex';
  deskContainer.style.alignItems='center';
  deskContainer.style.marginRight='10px';
  deskContainer.style.gap='2px';
  taskbar.prepend(deskContainer);

  for(let i=1;i<=NUM_DESKS;i++){
    const btn = document.createElement('div');
    btn.style.width='16px';
    btn.style.height='16px';
    btn.style.backgroundColor = i===1?'#00aaff':'#555';
    btn.style.cursor='pointer';
    btn.style.borderRadius='2px';
    deskContainer.appendChild(btn);
    btn.onclick = ()=>{
      switchDesk(i);
      deskContainer.querySelectorAll('div').forEach(b=>b.style.backgroundColor='#555');
      btn.style.backgroundColor='#00aaff';
    };
  }

  // Battery container
  const batteryContainer = document.createElement('div');
  batteryContainer.style.display='flex';
  batteryContainer.style.alignItems='center';
  batteryContainer.style.marginLeft='10px';
  taskbar.appendChild(batteryContainer);

  const batteryIcon = document.createElement('span');
  batteryIcon.innerHTML='&#128267;';
  batteryIcon.style.marginRight='5px';
  batteryIcon.style.color='#fff';
  batteryContainer.appendChild(batteryIcon);

  const batteryPercent = document.createElement('span');
  batteryPercent.textContent='100%';
  batteryPercent.style.color='#fff';
  batteryContainer.appendChild(batteryPercent);

  if(navigator.getBattery){
    navigator.getBattery().then(b=>{
      function update(){ batteryPercent.textContent=Math.round(b.level*100)+'%'; }
      update();
      b.addEventListener('levelchange', update);
    });
  }
}
</script>
<script src="https://js-dos.com/6.22.0/js-dos.js"></script>

<script>
// Check if doom.exe exists in Files app (assuming localStorage stores Base64)
function doomExists() {
  return localStorage.getItem('files/doom.exe') !== null;
}

// Only add icon if Doom is available
if(doomExists()){
  const desktop = document.getElementById('desktop') || document.body;

  // Create Doom icon
  const doomIcon = document.createElement('div');
  doomIcon.className = 'icon';
  doomIcon.style.position = 'absolute';
  doomIcon.style.top = '50px';
  doomIcon.style.left = '50px';
  doomIcon.style.cursor = 'pointer';
  doomIcon.innerHTML = 'üïπÔ∏è Doom';
  desktop.appendChild(doomIcon);

  // Create Doom window
  const doomWindow = document.createElement('div');
  doomWindow.id = 'doomWindow';
  doomWindow.style.display = 'none';
  doomWindow.style.position = 'absolute';
  doomWindow.style.top = '50px';
  doomWindow.style.left = '50px';
  doomWindow.style.width = '640px';
  doomWindow.style.height = '480px';
  doomWindow.style.background = '#000';
  doomWindow.style.border = '2px solid #fff';
  doomWindow.innerHTML = `<div style="text-align:right;"><button onclick="closeDoom()">X</button></div>
                          <div id="dosContainer" style="width:100%;height:90%;"></div>`;
  desktop.appendChild(doomWindow);

  let emulator = null;

  async function runDoom() {
    const exe = localStorage.getItem('files/doom.exe');
    const wad = localStorage.getItem('files/doom.wad');
    if(!exe || !wad){ alert('Doom files missing'); return; }

    const doomFiles = {
      'DOOM.EXE': Uint8Array.from(atob(exe), c => c.charCodeAt(0)),
      'DOOM.WAD': Uint8Array.from(atob(wad), c => c.charCodeAt(0))
    };

    doomWindow.style.display='block';

    Dos(document.getElementById('dosContainer'), { wdosboxUrl: "https://js-dos.com/6.22.0/wdosbox.js" })
      .ready.then(fs => {
        emulator = fs;
        Object.entries(doomFiles).forEach(([name, data]) => fs.createFile(name, data));
        fs.run("DOOM.EXE");
      });
  }

  function closeDoom(){
    if(emulator) emulator.exit();
    doomWindow.style.display='none';
  }

  doomIcon.addEventListener('click', runDoom);
}
</script>
<script src="https://js-dos.com/6.22.0/js-dos.js"></script>

<script>
// --- Dynamic Apps Launcher ---
// Assumes your Files app stores files in localStorage as Base64
// Example: localStorage['files/doom.exe'] = <Base64 string>
//          localStorage['files/doom.wad'] = <Base64 string if needed>

const desktop = document.getElementById('desktop') || document.body;
const files = Object.keys(localStorage)
  .filter(k => k.startsWith('files/') && k.endsWith('.exe'));

// Position icons automatically
let iconTop = 50;
let iconLeft = 50;
const iconSpacingX = 100;
const iconSpacingY = 100;
const iconsPerRow = 5;

// Create app icon + window for each exe
files.forEach((file, index) => {
  const appName = file.split('/').pop().replace('.exe','');

  // Create desktop icon
  const icon = document.createElement('div');
  icon.className = 'icon';
  icon.style.position = 'absolute';
  icon.style.top = iconTop + 'px';
  icon.style.left = iconLeft + 'px';
  icon.style.cursor = 'pointer';
  icon.style.textAlign = 'center';
  icon.innerHTML = 'üïπÔ∏è<br>' + appName;
  desktop.appendChild(icon);

  // Update icon positions
  iconLeft += iconSpacingX;
  if((index+1) % iconsPerRow === 0){ iconLeft = 50; iconTop += iconSpacingY; }

  // Create app window
  const win = document.createElement('div');
  win.id = appName + 'Window';
  win.style.display = 'none';
  win.style.position = 'absolute';
  win.style.top = '50px';
  win.style.left = '50px';
  win.style.width = '640px';
  win.style.height = '480px';
  win.style.background = '#000';
  win.style.border = '2px solid #fff';
  win.innerHTML = `<div style="text-align:right;">
                      <button onclick="closeApp('${appName}')">X</button>
                    </div>
                    <div id="container_${appName}" style="width:100%;height:90%;"></div>`;
  desktop.appendChild(win);

  let emulator = null;

  // Function to run app
  icon.addEventListener('click', async ()=>{
    const exeBase64 = localStorage.getItem(file);
    if(!exeBase64){ alert(appName+' file missing'); return; }

    // Check for additional .wad or supporting files if needed
    const extraFiles = {};
    Object.keys(localStorage).forEach(k=>{
      if(k.startsWith('files/') && k.endsWith('.wad')){
        const keyName = k.split('/').pop().toUpperCase();
        extraFiles[keyName] = Uint8Array.from(atob(localStorage.getItem(k)), c => c.charCodeAt(0));
      }
    });

    const mainExe = Uint8Array.from(atob(exeBase64), c=>c.charCodeAt(0));

    // Show window
    win.style.display='block';

    Dos(document.getElementById('container_'+appName), { wdosboxUrl: "https://js-dos.com/6.22.0/wdosbox.js" })
      .ready.then(fs=>{
        emulator = fs;
        fs.createFile(file.split('/').pop().toUpperCase(), mainExe);
        // Mount extra files (WADs etc.)
        Object.entries(extraFiles).forEach(([name,data])=>fs.createFile(name,data));
        fs.run(file.split('/').pop().toUpperCase());
      });
    
    // Save emulator reference for closing
    win.emulator = emulator;
  });

  // Close app function
  window.closeApp = function(name){
    const w = document.getElementById(name+'Window');
    if(w && w.emulator) w.emulator.exit();
    if(w) w.style.display='none';
  };
});
</script>
<script src="https://js-dos.com/6.22.0/js-dos.js"></script>

<script>
// --- Custom icons for known apps ---
const filesIcons = {
  'doom.exe': 'üïπÔ∏è',
  'snake.exe': 'üêç',
  'tetris.exe': 'üü¶',
  // Add more mappings as needed
};

// --- Dynamic Desktop Apps ---
const desktop = document.getElementById('desktop') || document.body;
const files = Object.keys(localStorage)
  .filter(k => k.startsWith('files/') && k.endsWith('.exe'));

// Automatic icon positioning
let iconTop = 50;
let iconLeft = 50;
const iconSpacingX = 100;
const iconSpacingY = 100;
const iconsPerRow = 5;

files.forEach((file,index) => {
  const appName = file.split('/').pop().replace('.exe','');
  const iconEmoji = filesIcons[file.split('/').pop().toLowerCase()] || 'üñ•Ô∏è';

  // --- Create Desktop Icon ---
  const icon = document.createElement('div');
  icon.className = 'desktop-icon';
  icon.style.position = 'absolute';
  icon.style.top = iconTop + 'px';
  icon.style.left = iconLeft + 'px';
  icon.style.cursor = 'grab';
  icon.style.textAlign = 'center';
  icon.style.width = '80px';
  icon.style.userSelect = 'none';
  icon.innerHTML = `<div style="font-size:32px;">${iconEmoji}</div><div>${appName}</div>`;
  desktop.appendChild(icon);

  // Update position for next icon
  iconLeft += iconSpacingX;
  if((index+1) % iconsPerRow === 0){ iconLeft = 50; iconTop += iconSpacingY; }

  // --- Make icon draggable ---
  icon.onmousedown = function(e){
    let shiftX = e.clientX - icon.getBoundingClientRect().left;
    let shiftY = e.clientY - icon.getBoundingClientRect().top;

    function moveAt(pageX,pageY){
      icon.style.left = pageX - shiftX + 'px';
      icon.style.top = pageY - shiftY + 'px';
    }

    function onMouseMove(e){
      moveAt(e.pageX, e.pageY);
    }

    document.addEventListener('mousemove', onMouseMove);
    icon.onmouseup = function(){
      document.removeEventListener('mousemove', onMouseMove);
      icon.onmouseup = null;
    };
  };
  icon.ondragstart = () => false;

  // --- Create App Window ---
  const win = document.createElement('div');
  win.id = appName+'Window';
  win.style.display = 'none';
  win.style.position = 'absolute';
  win.style.top = '50px';
  win.style.left = '50px';
  win.style.width = '640px';
  win.style.height = '480px';
  win.style.background = '#000';
  win.style.border = '2px solid #fff';
  win.style.resize = 'both';
  win.style.overflow = 'hidden';
  win.style.zIndex = 100;
  win.innerHTML = `
    <div style="text-align:right;background:#111;padding:2px;">
      <button onclick="closeApp('${appName}')">X</button>
    </div>
    <div id="container_${appName}" style="width:100%;height:90%;"></div>
  `;
  desktop.appendChild(win);

  let emulator = null;

  // --- Run App ---
  icon.addEventListener('click', async ()=>{
    const exeBase64 = localStorage.getItem(file);
    if(!exeBase64){ alert(appName+' file missing'); return; }

    // Mount extra supporting files
    const extraFiles = {};
    Object.keys(localStorage).forEach(k=>{
      if(k.startsWith('files/') && k.endsWith('.wad')){
        const keyName = k.split('/').pop().toUpperCase();
        extraFiles[keyName] = Uint8Array.from(atob(localStorage.getItem(k)), c=>c.charCodeAt(0));
      }
    });

    const mainExe = Uint8Array.from(atob(exeBase64), c=>c.charCodeAt(0));
    win.style.display='block';

    Dos(document.getElementById('container_'+appName), { wdosboxUrl: "https://js-dos.com/6.22.0/wdosbox.js" })
      .ready.then(fs=>{
        emulator = fs;
        fs.createFile(file.split('/').pop().toUpperCase(), mainExe);
        Object.entries(extraFiles).forEach(([name,data])=>fs.createFile(name,data));
        fs.run(file.split('/').pop().toUpperCase());
      });

    win.emulator = emulator;
  });

  // --- Close App Function ---
  window.closeApp = function(name){
    const w = document.getElementById(name+'Window');
    if(w && w.emulator) w.emulator.exit();
    if(w) w.style.display='none';
  };
});
</script>
<script src="https://js-dos.com/6.22.0/js-dos.js"></script>

<script>
// --- Desktop HTML file icons ---
const desktop = document.getElementById('desktop') || document.body;

// Map custom icons for known HTML files
const htmlIcons = {
  'index.html': 'üè†',
  'about.html': '‚ÑπÔ∏è',
  'game.html': 'üéÆ',
  // Add more mappings
};

// --- Add icons dynamically ---
Object.keys(localStorage)
  .filter(k => k.startsWith('files/') && k.endsWith('.html'))
  .forEach((fileKey, index)=>{
    const fileName = fileKey.split('/').pop();
    const iconEmoji = htmlIcons[fileName.toLowerCase()] || 'üìÑ';

    const icon = document.createElement('div');
    icon.className='desktop-icon';
    icon.style.position='absolute';
    icon.style.top = (50 + Math.floor(index/5)*100)+'px';
    icon.style.left = (50 + (index%5)*100)+'px';
    icon.style.textAlign='center';
    icon.style.width='80px';
    icon.style.cursor='grab';
    icon.style.userSelect='none';
    icon.innerHTML = `<div style="font-size:32px;">${iconEmoji}</div><div>${fileName}</div>`;
    desktop.appendChild(icon);

    // Drag & drop
    icon.onmousedown = function(e){
      let shiftX = e.clientX - icon.getBoundingClientRect().left;
      let shiftY = e.clientY - icon.getBoundingClientRect().top;
      function moveAt(pageX,pageY){
        icon.style.left = pageX-shiftX+'px';
        icon.style.top = pageY-shiftY+'px';
      }
      function onMouseMove(e){ moveAt(e.pageX,e.pageY); }
      document.addEventListener('mousemove',onMouseMove);
      icon.onmouseup = function(){ document.removeEventListener('mousemove',onMouseMove); icon.onmouseup=null; };
    };
    icon.ondragstart = ()=>false;

    // Open in browser on double click
    icon.ondblclick = ()=>{
      openHTMLFromFiles(fileKey);
    };
});

// --- Browser integration ---
const browserIcon = document.createElement('div');
browserIcon.className='desktop-icon';
browserIcon.style.position='absolute';
browserIcon.style.top='50px';
browserIcon.style.left='300px';
browserIcon.style.textAlign='center';
browserIcon.style.width='80px';
browserIcon.style.cursor='pointer';
browserIcon.style.userSelect='none';
browserIcon.innerHTML=`<div style="font-size:32px;">üåê</div><div>Browser</div>`;
desktop.appendChild(browserIcon);

// Browser Window
const browserWindow = document.createElement('div');
browserWindow.id='browserWindow';
browserWindow.style.display='none';
browserWindow.style.position='absolute';
browserWindow.style.top='50px';
browserWindow.style.left='50px';
browserWindow.style.width='900px';
browserWindow.style.height='600px';
browserWindow.style.background='#fff';
browserWindow.style.border='2px solid #000';
browserWindow.style.resize='both';
browserWindow.style.overflow='hidden';
browserWindow.style.zIndex=100;
browserWindow.innerHTML=`
  <div id="browserToolbar" style="display:flex;align-items:center;background:#111;color:white;padding:2px;">
    <button id="backBtn">‚óÄ</button>
    <button id="forwardBtn">‚ñ∂</button>
    <button id="reloadBtn">‚ü≥</button>
    <input id="browserAddress" type="text" style="flex:1;margin:0 5px;" placeholder="https://example.com">
    <button id="bookmarkBtn">‚òÖ</button>
    <button id="newTabBtn">+</button>
    <button id="closeBrowser" style="background:#f00;color:#fff;">X</button>
  </div>
  <div id="bookmarksContainer" style="background:#222;color:white;padding:2px;overflow-x:auto;white-space:nowrap;"></div>
  <div id="tabsContainer" style="display:flex;background:#333;color:#fff;overflow-x:auto;"></div>
  <div id="iframeContainer" style="width:100%;height:calc(100% - 90px);border:none;"></div>
`;
desktop.appendChild(browserWindow);
browserIcon.addEventListener('click',()=>{ browserWindow.style.display='block'; });
document.getElementById('closeBrowser').addEventListener('click',()=>{ browserWindow.style.display='none'; });

// --- Tabs/Bookmarks logic ---
let tabs=[], currentTab=-1;

// Load saved tabs
const savedTabs = JSON.parse(localStorage.getItem('browserTabs')||'[]');
savedTabs.forEach(url=>createTab(url));

// Functions from previous implementation...
// createTab(url), switchTab(id), saveTabs(), saveBookmark(url), renderBookmarks(), openHTMLFromFiles(fileKey)
// (You can reuse all code from the persistent browser snippet above)

// --- Drag & Drop support for opening HTML ---
browserWindow.addEventListener('dragover', e=>e.preventDefault());
browserWindow.addEventListener('drop', e=>{
  e.preventDefault();
  for(const f of e.dataTransfer.files){
    const reader = new FileReader();
    reader.onload = function(ev){
      const base64 = btoa(ev.target.result);
      const key = 'files/'+f.name;
      localStorage.setItem(key, base64);
      openHTMLFromFiles(key);
    };
    reader.readAsBinaryString(f);
  }
});
</script>
<script>
// --- Taskbar ---
const taskbar = document.createElement('div');
taskbar.id='taskbar';
taskbar.style.position='absolute';
taskbar.style.bottom='0';
taskbar.style.left='0';
taskbar.style.width='100%';
taskbar.style.height='40px';
taskbar.style.background='#222';
taskbar.style.display='flex';
taskbar.style.alignItems='center';
taskbar.style.padding='0 5px';
taskbar.style.zIndex=9999;
desktop.appendChild(taskbar);

// --- Manage Windows ---
let windows = [];
let zIndexCounter = 100;

function createWindow(title, contentElement){
  const win = document.createElement('div');
  win.className='osWindow';
  win.style.position='absolute';
  win.style.top='50px';
  win.style.left='50px';
  win.style.width='640px';
  win.style.height='480px';
  win.style.border='2px solid #fff';
  win.style.background='#000';
  win.style.resize='both';
  win.style.overflow='hidden';
  win.style.zIndex = ++zIndexCounter;

  // Window header with controls
  const header = document.createElement('div');
  header.style.height='30px';
  header.style.background='#111';
  header.style.display='flex';
  header.style.alignItems='center';
  header.style.justifyContent='space-between';
  header.style.cursor='move';
  header.style.color='#fff';
  header.innerHTML=`<span>${title}</span>
    <div>
      <button class="minBtn">‚Äî</button>
      <button class="maxBtn">‚òê</button>
      <button class="closeBtn">‚úï</button>
    </div>`;
  win.appendChild(header);

  // Window content
  const content = document.createElement('div');
  content.style.width='100%';
  content.style.height='calc(100% - 30px)';
  content.appendChild(contentElement);
  win.appendChild(content);

  desktop.appendChild(win);

  // Draggable header
  header.onmousedown = function(e){
    let shiftX = e.clientX - win.getBoundingClientRect().left;
    let shiftY = e.clientY - win.getBoundingClientRect().top;
    function moveAt(pageX,pageY){
      win.style.left = pageX-shiftX+'px';
      win.style.top = pageY-shiftY+'px';
    }
    function onMouseMove(e){ moveAt(e.pageX,e.pageY); }
    document.addEventListener('mousemove', onMouseMove);
    document.onmouseup = function(){ document.removeEventListener('mousemove', onMouseMove); document.onmouseup=null; };
    win.style.zIndex = ++zIndexCounter;
  };
  header.ondragstart = ()=>false;

  // Taskbar button
  const taskBtn = document.createElement('button');
  taskBtn.innerText = title;
  taskBtn.style.marginRight='2px';
  taskbar.appendChild(taskBtn);

  taskBtn.onclick = ()=>{
    if(win.style.display==='none') win.style.display='block';
    win.style.zIndex = ++zIndexCounter;
  };

  // Minimize
  header.querySelector('.minBtn').onclick = ()=>{ win.style.display='none'; };

  // Maximize
  let maximized=false;
  header.querySelector('.maxBtn').onclick = ()=>{
    if(!maximized){
      win.dataset.prevWidth = win.style.width;
      win.dataset.prevHeight = win.style.height;
      win.dataset.prevTop = win.style.top;
      win.dataset.prevLeft = win.style.left;
      win.style.top='0';
      win.style.left='0';
      win.style.width='100%';
      win.style.height='calc(100% - 40px)';
      maximized=true;
    } else {
      win.style.top = win.dataset.prevTop;
      win.style.left = win.dataset.prevLeft;
      win.style.width = win.dataset.prevWidth;
      win.style.height = win.dataset.prevHeight;
      maximized=false;
    }
  };

  // Close
  header.querySelector('.closeBtn').onclick = ()=>{
    win.remove();
    taskBtn.remove();
  };

  windows.push(win);
  return win;
}

// --- Example: Integrate Browser and Doom ---
browserIcon.addEventListener('click', ()=>{
  const iframe = document.createElement('iframe');
  iframe.style.width='100%';
  iframe.style.height='100%';
  iframe.style.border='none';
  iframe.src = 'about:blank';
  createWindow('Browser', iframe).style.display='block';
});

// Example for Doom
const doomIcon = document.createElement('div');
doomIcon.className='desktop-icon';
doomIcon.style.position='absolute';
doomIcon.style.top='50px';
doomIcon.style.left='400px';
doomIcon.style.textAlign='center';
doomIcon.style.width='80px';
doomIcon.style.cursor='pointer';
doomIcon.style.userSelect='none';
doomIcon.innerHTML=`<div style="font-size:32px;">üïπÔ∏è</div><div>Doom</div>`;
desktop.appendChild(doomIcon);

doomIcon.onclick = async ()=>{
  const container = document.createElement('div');
  await Dos(container, {wdosboxUrl:"https://js-dos.com/6.22.0/wdosbox.js"}).ready;
  createWindow('Doom', container).style.display='block';
};
</script>
<script>
// Reference existing browser window
const browserIcon = document.getElementById('browserIcon');
const browserWindow = document.getElementById('browserWindow');
const addressInput = document.getElementById('browserAddress');
const browserFrame = document.getElementById('browserFrame'); // this can be a <webview> or <object> if you want

browserIcon.onclick = ()=>{
    browserWindow.style.display='block';
};

// When user enters URL or double-clicks a file
function openBrowser(url){
    // Navigate to Python-served content
    window.location.href = url; // replaces iframe; loads real file served by Python
}

// Load Files app dynamically
fetch("/api/list_files")
    .then(res=>res.json())
    .then(files=>{
        files.forEach(file=>{
            const icon = document.createElement('div');
            icon.className='desktop-icon';
            icon.innerText=file;
            icon.ondblclick = ()=>{
                openBrowser(`/files/${file}`);
            };
            document.body.appendChild(icon);
        });
    });

// Handle address bar
document.getElementById('goBtn').onclick = ()=>{
    let url = addressInput.value;
    if(!url.startsWith('http')) url='/files/'+url; // optionally resolve local files
    openBrowser(url);
};
</script>

<script>
// Reference desktop container
const desktop = document.getElementById('desktop');

// Open Python-powered URLs
const browserIconEl = document.getElementById('browserIcon');
browserIconEl.onclick = () => {
    let url = prompt("Enter URL or file name from Files app:");
    if(!url) return;

    // If it doesn‚Äôt start with http, assume local file
    if(!url.startsWith("http")) url = `/files/${url}`;

    // Open file in the current window
    window.location.href = url;
};

// Dynamically load Files app icons
fetch("/api/list_files")
  .then(res => res.json())
  .then(files => {
    files.forEach((file,i)=>{
      const icon = document.createElement('div');
      icon.className='desktop-icon';
      icon.style.top = (50 + Math.floor(i/5)*100)+'px';
      icon.style.left = (50 + (i%5)*100)+'px';
      icon.innerHTML = 'üìÑ<div>'+file+'</div>';
      icon.ondblclick = ()=>{
        // Open file via Python backend
        window.location.href = `/files/${file}`;
      };
      desktop.appendChild(icon);
    });
  });

// Optional: drag & drop for icons (basic)
let dragged;
desktop.addEventListener("dragstart", e => dragged = e.target);
desktop.addEventListener("dragend", e => {
  dragged.style.top = e.pageY - 40 + "px";
  dragged.style.left = e.pageX - 40 + "px";
});
</script>

<!-- Game Streaming App Icon -->
<div id="gameApp" class="desktop-icon" style="top:200px; left:50px; width:80px; text-align:center; cursor:pointer;">
    üéÆ<div>Game Stream</div>
</div>

<script>
const gameApp = document.getElementById('gameApp');

gameApp.onclick = () => {
    const gameId = prompt("Enter GeForce NOW Game ID (or Parsec session):");
    if(!gameId) return;
    // Open streamed game in Python backend route
    window.open(`/game/geforcenow/${gameId}`, "_blank");
};
</script>
<!-- Right-click Context Menu -->
<div id="contextMenu"
     style="display:none; position:absolute; 
            background:#2c2c2c; /* solid background, no blur */
            color:#fff; 
            padding:6px; 
            border-radius:6px;
            box-shadow:0 4px 12px rgba(0,0,0,0.4); 
            z-index:9999; /* make sure it's on top */
            width:220px; 
            font-family:sans-serif; font-size:14px;">

    <strong style="color:#bbb; font-size:12px;">Default</strong>
    <div class="menu-item" onclick="copyItem()">üìã Copy</div>
    <div class="menu-item" onclick="cutItem()">‚úÇÔ∏è Cut</div>
    <div class="menu-item" onclick="pasteItem()">üì• Paste</div>
    <hr style="border:0; border-top:1px solid #555; margin:6px 0;">

    <strong style="color:#bbb; font-size:12px;">Browser</strong>
    <div id="openMediaImage" class="menu-item" style="display:none;" onclick="openMedia('image')">üñºÔ∏è Open image in new tab</div>
    <div id="openMediaVideo" class="menu-item" style="display:none;" onclick="openMedia('video')">üé¨ Open video in new tab</div>
    <div id="openMediaAudio" class="menu-item" style="display:none;" onclick="openMedia('audio')">üéµ Open audio in new tab</div>
    <div class="menu-item" onclick="savePage()">üíæ Save page as HTML</div>
</div>

<style>
.menu-item {
  padding: 6px 10px;
  cursor: pointer;
}
.menu-item:hover {
  background: #444;
}
</style>
<script>
const contextMenu = document.getElementById('contextMenu');

document.addEventListener("contextmenu", function(e) {
    e.preventDefault(); // stop default right click
    console.log("Right click detected at", e.pageX, e.pageY); // debug

    contextMenu.style.top = e.pageY + "px";
    contextMenu.style.left = e.pageX + "px";
    contextMenu.style.display = "block";
});

// hide when clicking elsewhere
document.addEventListener("click", function() {
    contextMenu.style.display = "none";
});
</script>
<script>
let selectedFile = null; // store which file is right-clicked

// --- COPY ---
async function copyItem() {
    if (!selectedFile) return alert("No file selected");

    await fetch("/clipboard/copy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: selectedFile })
    });

    alert("Copied: " + selectedFile);
}

// --- CUT ---
async function cutItem() {
    if (!selectedFile) return alert("No file selected");

    await fetch("/clipboard/cut", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: selectedFile })
    });

    alert("Cut: " + selectedFile);
}

// --- PASTE ---
async function pasteItem() {
    let res = await fetch("/clipboard/paste", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({target:"/home/webos/Desktop"}) // or current folder path
    });

    let data = await res.json();

    if (data.status === "pasted") {
        alert("Pasted: " + data.to);
        refreshDesktop(); // reload UI
    } else {
        alert("Clipboard empty");
    }
}

// --- RENAME ---
async function renameItem() {
    if (!selectedFile) return alert("No file selected");

    let newName = prompt("Enter new file name:", "");
    if (!newName) return;

    let res = await fetch("/files/rename", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: selectedFile, new_name: newName })
    });

    let data = await res.json();

    if (data.status === "renamed") {
        alert("Renamed to " + newName);
        refreshDesktop(); // reload UI
    } else {
        alert("Error: " + data.error);
    }
}
</script>
<script>
// --- DELETE ---
async function deleteItem() {
    if (!selectedFile) return alert("No file selected");

    if (!confirm("Delete " + selectedFile + "?")) return;

    let res = await fetch("/files/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: selectedFile })
    });

    let data = await res.json();

    if (data.status === "deleted") {
        alert("Deleted: " + selectedFile);
        refreshDesktop();
    } else {
        alert("Error: " + data.error);
    }
}

// --- NEW FOLDER ---
async function newFolder() {
    let name = prompt("Enter new folder name:", "New Folder");
    if (!name) return;

    let res = await fetch("/files/new_folder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: "/home/webos/Desktop", name: name })
    });

    let data = await res.json();

    if (data.status === "created") {
        alert("Folder created: " + name);
        refreshDesktop();
    } else {
        alert("Error: " + data.error);
    }
}

// --- NEW FILE ---
async function newFile() {
    let name = prompt("Enter new file name:", "New File.txt");
    if (!name) return;

    let res = await fetch("/files/new_file", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: "/home/webos/Desktop", name: name })
    });

    let data = await res.json();

    if (data.status === "created") {
        alert("File created: " + name);
        refreshDesktop();
    } else {
        alert("Error: " + data.error);
    }
}
</script>


</body>
</html>
